name: Publish PR

on:
  workflow_run:
    workflows: ['Main CI']
    types:
      - completed

permissions:
  contents: read

jobs:
  version:
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    permissions:
      actions: read
    runs-on: ubuntu-latest
    outputs:
      nextVersionTag: ${{ steps.newVersion.outputs.nextVersionTag }}

    steps:
      - id: newVersion
        uses: ./.github/actions/get-version-from-logs

  publish-packages-pr:
    uses: ./.github/workflows/publish.yml
    needs: [version]
    permissions:
      contents: read
      # Needed to publish with provenance (not needed for pull-request but requested by publish.yml workflow)
      id-token: write
    secrets: inherit
    with:
      version: ${{ needs.version.outputs.nextVersionTag }}-${{ github.event.workflow_run.run_attempt }}
      prerelease: true
      isPullRequest: true
      gitRef: ${{ github.event.workflow_run.pull_requests[0].base.ref }}

  notify-parent:
    runs-on: ubuntu-latest
    needs: [publish-packages-pr]
    if: success() || failure()
    permissions:
      # Needed to notify the parent workflow
      checks: write
    steps:
      - uses: ./.github/actions/notify-parent-flow
        with:
          publish-result: ${{ needs.publish-packages-pr.result }}
