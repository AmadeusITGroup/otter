<section>
  @if (rulesetExecutions) {
    <ul class="rulesets">
      @for (execution of rulesetExecutions; track execution) {
        <li class="ruleset">
          <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -- need to refactor the div to accordion from DF #1518 -->
          <div class="ruleset-panel-title ruleset-expansion-action"
               [class.error]="execution.type === 'RulesetExecutionError'"
               (click)="toggleExpansion(execution.executionId, 'ruleset')">
            <div><span [title]="'This ruleset has been evaluated ' + execution.executionCounter + ' time(s)'">{{execution.executionCounter}}</span> - {{execution.rulesetName | titlecase }}
              @if (execution.rulesetInformation?.linkedComponents?.or) {
                <div class="ruleset-panel-subtitle">
                  @for (lc of execution.rulesetInformation?.linkedComponents?.or; track lc; let isLast = $last) {
                    <div>{{lc.name}} {{lc.library}} @if (!isLast) {
                      <span> OR </span>
                    }</div>
                  }
                </div>
              }
              @if (execution.rulesetInformation?.validityRange; as validityRange) {
                <div class="ruleset-panel-subtitle">
                  Date range: {{validityRange.from}} - {{validityRange.to}}
                </div>
              }
            </div>
            <div class="ruleset-panel-title-aside">
              @if (execution.status === 'Error') {
                <span class="error capsule">Error</span>
              }
              @if (execution.status === 'Active') {
                <span class="success capsule">Applied</span>
              }
              @if (execution.status === 'Deactivated') {
                <span class="inactive capsule">Deactivated</span>
              }
              @if (execution.status === 'NoEffect') {
                <span class="warn capsule">No effect</span>
              }
              <span class="time capsule">
              <span>{{execution.timestamp | date: 'HH:mm:ss SSS'}}</span>
              <span>({{execution.duration | number: executionDurationFormat}}ms)</span>
            </span>
              <button
                class="icon"
                [class.icon-caret-down]="!expansionStatus[execution.executionId]?.ruleset"
                [class.icon-caret-up]="expansionStatus[execution.executionId]?.ruleset">
              </button>
            </div>
          </div>
          @if (expansionStatus[execution.executionId]?.ruleset) {
            <div class="ruleset-panel-description">
              <ng-container [ngTemplateOutlet]="rules"
                            [ngTemplateOutletContext]="{
                        rules: execution.rulesetInformation?.rules,
                        expansionID: execution.executionId
                      }"></ng-container>
              <ng-container [ngTemplateOutlet]="inputs"
                            [ngTemplateOutletContext]="{
                        inputs: execution.inputFacts
                      }"></ng-container>
              @if (execution.type === 'RulesetExecutionError') {
                <div class="ruleset-panel-category-title">Rules:</div>
                <ul class="ruleset-panel-category-body rule-description">
                  @for (ruleEvaluation of execution.rulesEvaluations; track ruleEvaluation; let index = $index) {
                    <li>
                      <ng-container>
                        <div class="ruleset-panel-title" [class.error]="ruleEvaluation.error">
                          <span>{{ruleEvaluation.rule.name | titlecase}} </span>
                          @if (ruleEvaluation.error) {
                            <span class="capsule error">Error</span>
                          }
                        </div>
                        <div>
                          @if (ruleEvaluation.error) {
                            <span class="ruleset-panel-category-title">Error:</span>
                            <pre class="ruleset-panel-category-body error">{{ruleEvaluation.error | o3rJsonOrString}}</pre>
                          }
                          <ng-container [ngTemplateOutlet]="inputs"
                                        [ngTemplateOutletContext]="{
                                  inputs: execution.inputFacts,
                                  runtimeInputs: execution.rulesetInformation?.rules[index]?.inputRuntimeFacts
                                }"></ng-container>
                          @if (!ruleEvaluation.error) {
                            <o3r-rule-actions-pres
                              [temporaryFacts]="ruleEvaluation.temporaryFacts"
                              [runtimeOutputs]="execution.rulesetInformation?.rules[index]?.outputRuntimeFacts"
                            ></o3r-rule-actions-pres>
                          }
                        </div>
                      </ng-container>
                    </li>
                  }
                </ul>
              } @else {
                <o3r-rule-actions-pres [actions]="execution.outputActions"></o3r-rule-actions-pres>
                <div class="ruleset-panel-category-title">Executed Rules</div>
                <ul class="rule-description ruleset-panel-category-body">
                  @for (ruleEvaluation of execution.rulesEvaluations; track ruleEvaluation; let index = $index) {
                    <li>
                      <div class="ruleset-panel-title">
                        <span>{{ruleEvaluation.rule.name | titlecase}}</span>
                        @if (ruleEvaluation.cached) {
                          <span class="capsule inactive">Cached</span>
                        }
                        <span class="capsule">({{ruleEvaluation.duration | number: executionDurationFormat}}ms)</span>
                      </div>
                      <div>
                        <ng-container [ngTemplateOutlet]="triggers"
                                      [ngTemplateOutletContext]="{triggers: (ruleEvaluation.triggers[ruleEvaluation.rule.id])}"></ng-container>
                        <o3r-rule-actions-pres
                          [actions]="ruleEvaluation.outputActions"
                          [temporaryFacts]="ruleEvaluation.temporaryFacts"
                          [runtimeOutputs]="execution.rulesetInformation?.rules[index]?.outputRuntimeFacts">
                        </o3r-rule-actions-pres>
                      </div>
                    </li>
                  }
                </ul>
              }
            </div>
          }
        </li>
      }
    </ul>
  } @else {
    <div class="alert alert-danger m-2" role="alert">
      The Rules Engine is not configured on this page.
    </div>
  }
</section>

<ng-template let-triggers="triggers" #triggers>
  <div class="ruleset-panel-category-title">Basefacts Triggers</div>
  <ul class="ruleset-panel-category-body triggers">
    @for (trigger of (triggers | keyvalue); track trigger) {
      @if (trigger.value?.factName) {
        <li>
          <o3r-rule-key-value-pres
            [key]="trigger.value.factName"
            [oldValue]="trigger.value.oldValue | o3rFallbackTo"
            [value]="trigger.value.newValue | o3rFallbackTo"
            [type]="'state'"></o3r-rule-key-value-pres>
        </li>
      }
    }
  </ul>
</ng-template>

<ng-template let-rules="rules" let-expansionID="expansionID" #rules>
  <!-- eslint-disable-next-line @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -- need to refactor the div to accordion from DF #1518 -->
  <div class="ruleset-panel-category-title ruleset-expansion-action"
       (click)="toggleExpansion(expansionID, 'rulesOverview')">
    <span>Rules Overview</span>
    <button class="icon"
            [class.icon-caret-down]="!expansionStatus[expansionID]?.rulesOverview"
            [class.icon-caret-up]="expansionStatus[expansionID]?.rulesOverview">
    </button>
  </div>
  @if (expansionStatus[expansionID]?.rulesOverview) {
    @if (rules?.length === 0) {
      <div class="ruleset-panel-category-body empty">No rule</div>
    }
    @if (rules?.length > 0) {
      <ul class="ruleset-panel-category-body">
        @for (rule of rules; track rule) {
          <li>
            <o3r-rule-tree-pres [name]="rule.name"
                                [condition]="rule?.rootElement?.condition"
                                [blockType]="rule?.rootElement?.blockType"
                                [successElements]="rule?.rootElement?.successElements"
                                [failureElements]="rule?.rootElement?.failureElements">
            </o3r-rule-tree-pres>
          </li>
        }
      </ul>
    }
  }
</ng-template>

<ng-template let-inputs="inputs" let-runtimeInputs="runtimeInputs" #inputs>
  <div class="ruleset-panel-category-title">Inputs snapshot</div>
  @if (inputs?.length === 0) {
    <div class="ruleset-panel-category-body empty">No inputs</div>
  }
  @if (inputs?.length > 0) {
    <ul class="ruleset-panel-category-body">
      @for (input of inputs; track input) {
        <li>
          <o3r-rule-key-value-pres
            [key]="input.factName"
            [value]="input.value | o3rFallbackTo"
            [type]="'state'"></o3r-rule-key-value-pres>
        </li>
      }
      @for (input of runtimeInputs; track input) {
        <li>{{input}} (scope limited to ruleset)</li>
      }
    </ul>
  }
</ng-template>
